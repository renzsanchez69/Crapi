<!DOCTYPE html>
<html>
	<head>
			<title>ORDER HISTORY</title>
			<meta name="viewport" content="width=device-width, initial-scale=1">
			<script src="js/o-main.js"></script>
			<link rel="stylesheet" type="text/css" href="css/o-main.css">
			<link rel="stylesheet" type="text/css" href="css/style.css">
			<link rel="stylesheet" href="css/font-awesome.min.css">
			<link rel="stylesheet" href="css/bootstrap.min.css">
			<script src="lib/jquery.min.js"></script>
			<script src="lib/bootstrap.min.js"></script>
	</head>
	<body>

		<!-- Top Navigation Menu -->
		<div class="topnav" id="myTopnav">
			<a href="e-menu.html">Food Menu</a>
			<a href="e-main.html">Orders</a>
			<a href="e-hist.html" class="active">Order History</a>
			<a href="index.html" id="log-out">Logout</a>
			<a href="javascript:void(0);" class="icon" onclick="myFunction()">
				<i class="fa fa-bars"></i>
			</a>
		</div>

		<div class="main">
			<br>
			<div class="title">
				<h1>Order History</h1>
			</div>
			<br>

			<div class="left">
				<form action="">
					<input class="search" type="text" placeholder="Search.." name="search">
					<button id="btnSearch" class="btn btn-default btn-lg"><i class="fa fa-search"></i></button>
				</form>
			</div>

			<table class="table table-condensed">
				<thead>
					<tr>
						<th>Order Date</th>
						<th>Full name</th>
						<th>Status</th>
					</tr>
				</thead>
				<tbody id="ordListResult"></tbody>

				<!-- data -->
				<tr id="masterOrdRow" class="hidden">
					<th class="ordDate">--</th>
					<th class="ordName">--</th>
					<th>
						<p class="ordViewBtn"></p>
					</th>
				</tr>
			</table>
		</div>
	</body>
	<script src="lib/jquery.min.js"></script>
	<script src="lib/bootstrap.min.js"></script>
	<script src="js/jquery.growl.js" type="text/javascript"></script>
	<script src="common/constants.js"></script>
	<script src="common/app.js"></script>
	<script>
		var myResto = null;
		var ordid = null;
		var orderList = {};
		$(document).ready(function(){
			loadRestaurantInfo(function(){
				loadOrders();
			});

			$('#btnSearch').click(function(e){
				e.preventDefault();
				loadOrders();
			});

		});

		function orderApprovedByEmployee(id){
			CrapiApp.updateOrder({
				order_id: id,
				is_delivered: 1
			})
			.then(function(res){
				$('.loader').remove();

				if (res.result === 'OK') {
					loadOrders();
				}
			})
			.catch(function(err){
				console.warn(err);
			});
		}

		function loadRestaurantInfo(callback){
			CrapiApp.searchResto({
				owner_id: CrapiApp.config.login_data.user_id
			})
			.then(function(res){
				$('.loader').remove();

				if (res.result === 'OK') {
					if (typeof res.data[0] !== 'undefined') {

						console.warn(res.data[0]);
						myResto = res.data[0];
						if (typeof callback == 'function') {
							callback();
						}
					}
				}
			})
			.catch(function(err){
				console.warn(err);
			});
		}
		
		function loadOrders(){
			CrapiApp.showCommonLoader();
			var search = $('[name="search"]').val();
			CrapiApp.orderEmpListUrl({
				search: search,
				order_status: [ORDER_STATUS.failed,ORDER_STATUS.success],
				owner_id: CrapiApp.config.login_data.user_id
			})
			.then(function(res){
				$('#ordListResult').html('');

				if (res.result === 'OK') {
					for (var key in res.data) {
						// skip loop if the property is from prototype
						if (!res.data.hasOwnProperty(key)) continue;
						var obj = res.data[key];
						var empRow = $('#masterOrdRow').clone();
						empRow.removeClass('hidden');
						empRow.find('.ordDate').html(obj.created_at);
						empRow.find('.ordName').html(obj.customer_fullname);
						console.log(obj.order_status);
						if(obj.order_status == "failed") {
							empRow.find('p.ordViewBtn').text('Not Successfully Delivered');
						} else {
							empRow.find('p.ordViewBtn').text('Successfully Delivered');
						}

						$('#ordListResult').append(empRow);

						orderList[obj.id] = obj;
					}
				}
			})
			.catch(function(err){
				console.warn(err);
			})
			.always(function(){
				CrapiApp.removeCommonLoader();
			});
		}

		function showOrderDetailModal(ordid, callback){
			CrapiApp.showCommonLoader();
			CrapiApp.getOrderDetails({
				order_id: ordid,
				order_status: ORDER_STATUS.success
			})
			.then(function(res){
				console.warn('ORDERDETAILS -----------------');
				console.warn(res);
				$('#ordDetailListResult').html('');
				if (typeof orderList[ordid] == 'undefined') {
					console.warn("Customer order not found.");
					return;
				}
				var customerInfo = orderList[ordid];
				$('#ordNumber').html(customerInfo.order_number);
				$('#ordNumberApprove').html(customerInfo.order_number);
				$('#customerInfo #custFullname').html(customerInfo.customer_fullname);
				$('#customerInfo #custAddress').html(customerInfo.customer_address);
				$('#customerInfo #custContactNumber').html(customerInfo.contact_number);
				$('#customerInfo #custEmail').html(customerInfo.email);
				$('#customerInfo #custCreated').html(customerInfo.created_at);

				if (res.result === 'OK') {
					var subTotalPrice = 0;
					for (var key in res.data) {
						// skip loop if the property is from prototype
						if (!res.data.hasOwnProperty(key)) continue;
						var obj = res.data[key];
						var ordDetRow = $('#masterOrdDetailRow').clone();
						ordDetRow.removeClass('hidden');
						ordDetRow.find('.ordDetProdname').html(obj.name);
						ordDetRow.find('.ordDetQty').html(obj.qty);
						ordDetRow.find('.ordDetPrice').html(obj.price);

						$('#ordDetailListResult').append(ordDetRow);
						subTotalPrice = Number(obj.price) + Number(subTotalPrice);
					}

					var vatObj = CrapiApp.calculateVat(subTotalPrice);
					$('#ordSubtotal').html(subTotalPrice);
					$('#ordVat').html(vatObj.amount);
					$('#ordTotalPayable').html(vatObj.total_payable);
				}

				if (typeof callback == 'function') {callback();}
			})
			.catch(function(err){
				console.warn(err);
			})
			.always(function(){
				CrapiApp.removeCommonLoader();
			});
		}
	</script>
</html>